<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdfaf6">

    <title>Alvorada - 1% Todo Dia</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #fdfaf6; --card-bg: #ffffff; --title-brown: #a68966;
            --add-red: #f28482; --check-green: #32cd32; --item-done-bg: #e8f5e9;
            --stats-green: #7ebc89; --bar-bg: rgba(0,0,0,0.05);
            --bar-1: #a8dadc; --bar-2: #ffcad4; --bar-3: #b9fbc0;
            --text-color: #5d5d5d; --date-color: #999;
            --input-border: #f0f0f0; --delete-red: #e74c3c;
        }

        [data-theme="dark"] {
            --bg-color: #1a1c22; --card-bg: #2d3039; --text-color: #e0e0e0;
            --input-border: #3d414d; --title-brown: #c5b299;
            --bar-bg: rgba(255,255,255,0.15); --item-done-bg: #1b3d2f;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.4s ease; min-height: 100vh; overflow-x: hidden;
        }

        /* Container Principal com dimensionamento recuperado */
        .container {
            width: 100%; max-width: 480px;
            background: var(--card-bg); padding: 30px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-top: 20px; position: relative; box-sizing: border-box;
        }

        /* Estilo do Login */
        #auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .auth-hidden { opacity: 0; visibility: hidden; pointer-events: none; transition: 0.8s; }

        /* Cabe√ßalho e Frases */
        header { margin-bottom: 30px; }
        h1 { font-family: 'Comfortaa', cursive; font-size: 1.6rem; color: var(--title-brown); margin: 0; }
        #quote-display { font-size: 0.85rem; font-style: italic; color: var(--date-color); margin-top: 10px; line-height: 1.4; min-height: 3em; }

        /* Lista de Metas */
        .todo-item { 
            background: var(--card-bg); border: 1px solid var(--input-border); 
            padding: 15px; border-radius: 15px; display: flex; 
            align-items: center; margin-bottom: 12px; transition: 0.3s;
        }
        .delete-btn { background: none; border: none; cursor: pointer; opacity: 0.3; margin-left: auto; font-size: 1.2rem; }
        .delete-btn:hover { opacity: 1; color: var(--delete-red); }

        /* Bot√£o Flutuante de Tema */
        .theme-toggle { position: fixed; bottom: 25px; right: 25px; width: 50px; height: 50px; border-radius: 50%; background: var(--title-brown); border: none; color: white; cursor: pointer; z-index: 900; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* Estilo do PDF (Ticket de Compra) */
        .pdf-export-only { display: none; }
        @media print {
            .ticket { width: 80mm; font-family: 'Courier New', Courier, monospace; padding: 10px; color: black !important; }
            .ticket-header { border-bottom: 1px dashed #000; text-align: center; padding-bottom: 10px; }
            .ticket-item { border-bottom: 1px dashed #eee; padding: 5px 0; font-size: 12px; }
        }
    </style>
</head>
<body ondblclick="toggleFullScreen()"> <div id="auth-container">
    <div class="container" style="text-align: center;">
        <h1 id="auth-title">Portaria Alvorada</h1>
        <input type="text" id="auth-login" placeholder="Seu Agente (Login)" style="width: 100%; margin: 15px 0 10px; padding: 15px; border-radius: 12px; border: 1px solid var(--input-border); font-size: 16px;">
        <input type="password" id="auth-password" placeholder="Senha" style="width: 100%; margin-bottom: 20px; padding: 15px; border-radius: 12px; border: 1px solid var(--input-border); font-size: 16px;">
        <button onclick="handleAuth()" id="auth-btn" style="width:100%; padding:18px; background:var(--title-brown); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ACESSAR SISTEMA</button>
        <p id="auth-toggle-text" style="cursor:pointer; margin-top:20px; font-size:0.85rem; text-decoration: underline;" onclick="toggleAuthMode()">N√£o tem conta? Cadastre-se</p>
        <p id="auth-error" style="color:var(--delete-red); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div class="container" id="main-app">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Alvorada</h1>
            <div id="streak-display" style="font-weight: bold; color: #ff9f43;">üî• 0 dias</div>
        </div>
        <div id="current-date" style="text-transform: capitalize; color: var(--title-brown); font-weight: 600; margin-top: 5px;"></div>
        <div id="quote-display">"Carregando motiva√ß√£o..."</div>
    </header>

    <div style="background: var(--bar-bg); height: 12px; border-radius: 10px; overflow: hidden; margin-bottom: 8px;">
        <div id="progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--bar-1), var(--bar-2), var(--bar-3)); transition: 0.6s ease;"></div>
    </div>
    <div id="stats" style="text-align: right; font-weight: 800; color: var(--stats-green); font-size: 0.9rem; margin-bottom: 25px;">Total: 0%</div>

    <div style="display: flex; gap: 10px; margin-bottom: 25px;">
        <input type="text" id="todo-input" placeholder="Nova miss√£o de hoje..." style="flex:1; padding:15px; border-radius:12px; border:1px solid var(--input-border); outline:none; font-size:16px;">
        <button onclick="addTodo()" style="background:var(--add-red); color:white; border:none; padding:0 20px; border-radius:12px; font-size:1.5rem; cursor:pointer;">+</button>
    </div>

    <ul id="todo-list" style="padding:0; list-style:none; margin-bottom: 30px;"></ul>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button onclick="exportToPDF()" style="background: none; border: 1px solid var(--title-brown); color: var(--title-brown); padding: 8px 15px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; cursor: pointer;">üìÑ Salvar em PDF (Ticket)</button>
        <button onclick="firebase.auth().signOut()" style="background:none; border:none; color:var(--date-color); font-size:0.75rem; text-decoration:underline; cursor:pointer;">Sair do Sistema</button>
    </div>
</div>

<button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>

<script>
    // 1. Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAavmFHrcPo8OY60hnLo2dK4BsylPKvPAQ",
      authDomain: "alvorada-23e01.firebaseapp.com",
      projectId: "alvorada-23e01",
      storageBucket: "alvorada-23e01.firebasestorage.app",
      messagingSenderId: "173441904175",
      appId: "1:173441904175:web:7d3a7aba8b90afa05ea0da"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. Banco de Frases (As 20 frases motivacionais recuperadas)
    const quotes = [
        "O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia.",
        "N√£o pare at√© se orgulhar.",
        "A const√¢ncia √© a amiga da perfei√ß√£o.",
        "1% melhor a cada dia.",
        "Vencer a si mesmo √© a maior das vit√≥rias.",
        "Grandes batalhas s√≥ s√£o dadas a grandes guerreiros.",
        "A disciplina √© a ponte entre metas e realiza√ß√µes.",
        "O que voc√™ faz hoje determina o seu amanh√£.",
        "N√£o espere motiva√ß√£o, cultive disciplina.",
        "Foque no processo, o resultado √© consequ√™ncia.",
        "Sua √∫nica competi√ß√£o √© quem voc√™ era ontem.",
        "Cada passo, por menor que seja, te aproxima do objetivo.",
        "A dor √© tempor√°ria, o cargo √© para sempre.",
        "Mantenha o foco nos estudos e a f√© na miss√£o.",
        "Agente: sua rotina √© seu treinamento.",
        "Transforme o 'eu n√£o consigo' em 'eu ainda estou aprendendo'.",
        "Estude enquanto eles dormem, viva o que eles sonham.",
        "A aprova√ß√£o √© o destino, a const√¢ncia √© o caminho.",
        "Seja mais forte que sua melhor desculpa.",
        "Miss√£o dada √© miss√£o cumprida."
    ];

    // 3. Vari√°veis de Estado
    let isLoginMode = true;
    let dbLocal = { todos: [], percent: 0 };
    const dateObj = new Date();
    // Formato solicitado: Dia da semana, Dia de M√™s (Sem o ano)
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    const todayStr = dateObj.toLocaleDateString('pt-BR', options);
    const dbKey = dateObj.toLocaleDateString('pt-BR'); // Chave para o Firebase (DD/MM/AAAA)

    // 4. Fun√ß√µes de Autentica√ß√£o (Com sanitiza√ß√£o para Nome de Usu√°rio)
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? "Portaria Alvorada" : "Recrutamento Alvorada";
        document.getElementById('auth-btn').innerText = isLoginMode ? "ACESSAR SISTEMA" : "CRIAR MINHA CONTA";
        document.getElementById('auth-toggle-text').innerText = isLoginMode ? "N√£o tem conta? Cadastre-se" : "J√° √© um Agente? Fa√ßa Login";
    }

    function handleAuth() {
        const loginRaw = document.getElementById('auth-login').value.trim();
        const password = document.getElementById('auth-password').value;
        if(!loginRaw || !password) return;

        // Converte o nome de usu√°rio em e-mail fict√≠cio (acordo t√°tico)
        const safeLogin = loginRaw.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const email = `${safeLogin}@alvorada.com`;
        
        const action = isLoginMode 
            ? firebase.auth().signInWithEmailAndPassword(email, password)
            : firebase.auth().createUserWithEmailAndPassword(email, password);

        action.catch(err => { document.getElementById('auth-error').innerText = "Erro: " + err.message; });
    }

    firebase.auth().onAuthStateChanged(user => {
        if(user) {
            document.getElementById('auth-container').classList.add('auth-hidden');
            loadData();
            showRandomQuote();
        } else {
            document.getElementById('auth-container').classList.remove('auth-hidden');
        }
    });

    // 5. Gerenciamento de Dados (Firebase + UI)
    async function loadData() {
        const user = firebase.auth().currentUser;
        if(!user) return;
        const doc = await db.collection("usuarios").doc(user.uid).collection("dias").doc(dbKey).get();
        if(doc.exists) {
            dbLocal = doc.data();
        } else {
            // Se for um novo dia, tenta trazer as tarefas do dia anterior (sem estarem marcadas)
            const lastDoc = await db.collection("usuarios").doc(user.uid).collection("dias").orderBy("__name__", "desc").limit(1).get();
            if(!lastDoc.empty) {
                const data = lastDoc.docs[0].data();
                dbLocal.todos = data.todos.map(t => ({...t, completed: false}));
            }
        }
        updateUI();
        updateStreak(user.uid);
    }

    function updateUI() {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        let done = 0;

        dbLocal.todos.forEach(t => {
            const li = document.createElement('li');
            li.className = 'todo-item';
            li.innerHTML = `
                <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo('${t.id}')" style="transform: scale(1.3); cursor: pointer;">
                <span style="margin-left:15px; flex:1; font-weight:500; ${t.completed ? 'text-decoration:line-through; opacity:0.4' : ''}">${t.text}</span>
                <button class="delete-btn" onclick="deleteTodo('${t.id}')">üóëÔ∏è</button>
            `;
            list.appendChild(li);
            if(t.completed) done++;
        });

        const p = dbLocal.todos.length > 0 ? Math.round((done / dbLocal.todos.length) * 100) : 0;
        if(p === 100 && dbLocal.percent < 100) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        
        dbLocal.percent = p;
        document.getElementById('progress-bar').style.width = p + '%';
        document.getElementById('stats').innerText = `Total: ${p}%`;
        saveData();
    }

    function saveData() {
        const user = firebase.auth().currentUser;
        if(user) db.collection("usuarios").doc(user.uid).collection("dias").doc(dbKey).set(dbLocal);
    }

    function addTodo() {
        const input = document.getElementById('todo-input');
        if(!input.value) return;
        // PACTO: DEFININDO ID √öNICO VIA TIMESTAMP
        dbLocal.todos.push({ id: Date.now().toString(), text: input.value, completed: false });
        input.value = '';
        updateUI();
    }

    function toggleTodo(id) {
        const t = dbLocal.todos.find(x => x.id === id);
        if(t) t.completed = !t.completed;
        updateUI();
    }

    function deleteTodo(id) {
        dbLocal.todos = dbLocal.todos.filter(x => x.id !== id);
        updateUI();
    }

    // 6. Funcionalidades Extras (Frases, Streak, Tema, FullScreen)
    function showRandomQuote() {
        const index = Math.floor(Math.random() * quotes.length);
        document.getElementById('quote-display').innerText = `"${quotes[index]}"`;
    }

    async function updateStreak(uid) {
        const snapshot = await db.collection("usuarios").doc(uid).collection("dias").where("percent", "==", 100).get();
        document.getElementById('streak-display').innerText = `üî• ${snapshot.size} dias`;
    }

    function toggleTheme() {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('theme-btn').innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => console.log(err));
        } else {
            document.exitFullscreen();
        }
    }

    // 7. Exporta√ß√£o para PDF Estilo Ticket de Compra (Acordo Recuperado)
    function exportToPDF() {
        const element = document.createElement('div');
        element.className = 'ticket';
        element.innerHTML = `
            <div style="text-align:center; font-family:monospace;">
                <h3>ALVORADA PROTOCOLO</h3>
                <p>RELAT√ìRIO DE MISS√ïES</p>
                <p>${todayStr}</p>
                <hr style="border:none; border-top:1px dashed #000;">
                <div style="text-align:left;">
                    ${dbLocal.todos.map(t => `<p>[${t.completed ? 'X' : ' '}] ${t.text}</p>`).join('')}
                </div>
                <hr style="border:none; border-top:1px dashed #000;">
                <p>APROVEITAMENTO: ${dbLocal.percent}%</p>
                <p>FOCO NA MISS√ÉO - PC</p>
            </div>
        `;
        
        const opt = {
            margin: 10,
            filename: `Alvorada_${dbKey.replace(/\//g, '-')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: [80, 150], orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    document.getElementById('current-date').innerText = todayStr;
</script>
</body>
</html>
