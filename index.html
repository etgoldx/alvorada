<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Alvorada - 1% Todo Dia</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #fdfaf6; --card-bg: #ffffff; --title-brown: #a68966;
            --add-red: #f28482; --check-green: #32cd32; --item-done-bg: #e8f5e9;
            --stats-green: #7ebc89; --bar-bg: rgba(0,0,0,0.05);
            --bar-1: #a8dadc; --bar-2: #ffcad4; --bar-3: #b9fbc0;
            --text-color: #5d5d5d; --date-color: #999;
            --input-border: #f0f0f0; --delete-red: #e74c3c;
        }

        [data-theme="dark"] {
            --bg-color: #1a1c22; --card-bg: #2d3039; --text-color: #e0e0e0;
            --input-border: #3d414d; --title-brown: #c5b299;
            --bar-bg: rgba(255,255,255,0.15); --item-done-bg: #1b3d2f;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: env(safe-area-inset-top) 20px 100px 20px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.4s ease; min-height: 100vh;
        }

        /* Container Principal re-dimensionado */
        .container {
            width: 100%; max-width: 480px; background: var(--card-bg); 
            padding: 35px; border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-top: 25px; box-sizing: border-box;
        }

        /* T√≠tulos e Data conforme vers√µes anteriores */
        h1 { font-family: 'Comfortaa', cursive; font-size: 1.8rem; color: var(--title-brown); margin: 0; }
        #date-box { font-size: 1.1rem; color: var(--title-brown); font-weight: 600; text-transform: capitalize; margin: 5px 0 25px 0; }

        /* Estilo das Miss√µes */
        .todo-item { 
            background: var(--card-bg); border: 1px solid var(--input-border); 
            padding: 16px; border-radius: 18px; display: flex; align-items: center; margin-bottom: 12px; 
        }
        .delete-btn { background: none; border: none; cursor: pointer; opacity: 0.3; margin-left: auto; font-size: 1.2rem; }

        /* Frases Motivacionais Centralizadas */
        #quote-display { 
            text-align: center; font-size: 0.9rem; font-style: italic; 
            color: var(--date-color); margin: 30px 0; line-height: 1.5; padding: 0 10px;
        }

        /* Bot√£o Gerar Relat√≥rio Solto */
        #btn-pdf {
            background: none; border: none; color: var(--date-color); 
            font-size: 0.8rem; font-weight: bold; cursor: pointer; 
            text-decoration: underline; margin-top: 10px; transition: 0.3s;
        }

        /* Bot√µes Flutuantes Lado a Lado */
        .fab-container { position: fixed; bottom: 30px; right: 25px; display: flex; gap: 10px; z-index: 1000; }
        .fab { 
            width: 50px; height: 50px; border-radius: 50%; border: none; 
            background: var(--title-brown); color: white; cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 1.2rem;
        }

        /* Tela de Login */
        #auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .auth-hidden { opacity: 0; visibility: hidden; pointer-events: none; transition: 0.8s; }

        /* Estilo Ticket para Impress√£o */
        .ticket-hidden { display: none; }
    </style>
</head>
<body ondblclick="toggleFullScreen()"> <div id="auth-container">
    <div class="container" style="text-align: center;">
        <h1 id="auth-title">Portaria Alvorada</h1>
        <input type="text" id="auth-login" placeholder="Nome de Usu√°rio" style="width: 100%; margin: 20px 0 10px; padding: 15px; border-radius: 12px; border: 1px solid var(--input-border); font-size: 16px;">
        <input type="password" id="auth-password" placeholder="Senha" style="width: 100%; margin-bottom: 20px; padding: 15px; border-radius: 12px; border: 1px solid var(--input-border); font-size: 16px;">
        <button onclick="handleAuth()" id="auth-btn" style="width:100%; padding:18px; background:var(--title-brown); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ACESSAR SISTEMA</button>
        <p id="auth-toggle-text" style="cursor:pointer; margin-top:20px; font-size:0.85rem;" onclick="toggleAuthMode()">Novo aqui? Registre seu Agente</p>
        <p id="auth-error" style="color:var(--delete-red); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div class="container" id="main-app">
    <header style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1>Alvorada</h1>
            <div id="date-box"></div> </div>
        <div id="streak-display" style="font-weight: 800; color: #ff9f43; font-size: 1.1rem;">üî• 0</div>
    </header>

    <div style="background: var(--bar-bg); height: 12px; border-radius: 10px; overflow: hidden; margin-bottom: 8px;">
        <div id="progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--bar-1), var(--bar-2), var(--bar-3)); transition: 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67);"></div>
    </div>
    <div id="stats" style="text-align: right; font-weight: 800; color: var(--stats-green); font-size: 0.9rem; margin-bottom: 30px;">Total: 0%</div>

    <div style="display: flex; gap: 10px; margin-bottom: 30px;">
        <input type="text" id="todo-input" placeholder="Nova miss√£o..." style="flex:1; padding:15px; border-radius:15px; border:1px solid var(--input-border); outline:none; font-size:16px;">
        <button onclick="addTodo()" style="background:var(--add-red); color:white; border:none; padding:0 22px; border-radius:15px; font-size:1.6rem; cursor:pointer;">+</button>
    </div>

    <ul id="todo-list" style="padding:0; list-style:none;"></ul>

    <div id="quote-display"></div>
    <div style="text-align: center;">
        <button id="btn-pdf" onclick="exportToPDF()">üìÑ Gerar Relat√≥rio (Ticket)</button>
    </div>
</div>

<div class="fab-container">
    <button class="fab" onclick="toggleTheme()" title="Alterar Tema">üåô</button>
    <button class="fab" onclick="firebase.auth().signOut()" title="Sair do Sistema">üö™</button>
</div>

<script>
    // Configura√ß√µes Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAavmFHrcPo8OY60hnLo2dK4BsylPKvPAQ",
      authDomain: "alvorada-23e01.firebaseapp.com",
      projectId: "alvorada-23e01",
      storageBucket: "alvorada-23e01.firebasestorage.app",
      messagingSenderId: "173441904175",
      appId: "1:173441904175:web:7d3a7aba8b90afa05ea0da"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 20 Frases de Motiva√ß√£o Recuperadas
    const quotes = [
        "O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia.", "N√£o pare at√© se orgulhar.", "A const√¢ncia √© a amiga da perfei√ß√£o.", "1% melhor a cada dia.", "Vencer a si mesmo √© a maior das vit√≥rias.", "Grandes batalhas s√≥ s√£o dadas a grandes guerreiros.", "A disciplina √© a ponte entre metas e realiza√ß√µes.", "O que voc√™ faz hoje determina o seu amanh√£.", "N√£o espere motiva√ß√£o, cultive disciplina.", "Foque no processo, o resultado √© consequ√™ncia.", "Sua √∫nica competi√ß√£o √© quem voc√™ era ontem.", "Cada passo te aproxima do objetivo.", "A dor √© tempor√°ria, o cargo √© para sempre.", "Mantenha o foco nos estudos e a f√© na miss√£o.", "Agente: sua rotina √© seu treinamento.", "Transforme o 'n√£o consigo' em 'estou aprendendo'.", "Estude enquanto eles dormem, viva o que eles sonham.", "A aprova√ß√£o √© o destino, a const√¢ncia √© o caminho.", "Seja mais forte que sua melhor desculpa.", "Miss√£o dada √© miss√£o cumprida."
    ];

    let isLoginMode = true;
    let dbLocal = { todos: [], percent: 0 };
    const dateObj = new Date();
    // Formata√ß√£o da Data: Quinta-feira, 29 de Janeiro (sem ano)
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    const todayStr = dateObj.toLocaleDateString('pt-BR', options);
    const dbKey = dateObj.toLocaleDateString('pt-BR'); // Chave de busca (DD/MM/AAAA)

    // L√≥gica de Autentica√ß√£o (Login por Nome)
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? "Portaria Alvorada" : "Recrutamento Alvorada";
        document.getElementById('auth-btn').innerText = isLoginMode ? "ACESSAR SISTEMA" : "CRIAR MINHA CONTA";
        document.getElementById('auth-toggle-text').innerText = isLoginMode ? "Novo aqui? Registre seu Agente" : "J√° √© um Agente? Fa√ßa Login";
    }

    function handleAuth() {
        const login = document.getElementById('auth-login').value.trim();
        const password = document.getElementById('auth-password').value;
        if(!login || !password) return;
        const email = `${login.toLowerCase().replace(/\s/g, '')}@alvorada.com`; // Sanitiza√ß√£o t√°tica
        const btn = document.getElementById('auth-btn');
        btn.innerText = "PROCESSANDO...";
        const action = isLoginMode ? firebase.auth().signInWithEmailAndPassword(email, password) : firebase.auth().createUserWithEmailAndPassword(email, password);
        action.catch(err => { btn.innerText = "TENTAR NOVAMENTE"; document.getElementById('auth-error').innerText = "Erro: " + err.message; });
    }

    firebase.auth().onAuthStateChanged(user => {
        if(user) {
            document.getElementById('auth-container').classList.add('auth-hidden');
            loadData();
            showRandomQuote();
        } else {
            document.getElementById('auth-container').classList.remove('auth-hidden');
        }
    });

    // Banco de Dados e UI
    async function loadData() {
        const user = firebase.auth().currentUser;
        if(!user) return;
        const doc = await db.collection("usuarios").doc(user.uid).collection("dias").doc(dbKey).get();
        if(doc.exists) {
            dbLocal = doc.data();
        } else {
            // Tenta herdar miss√µes do √∫ltimo registro para const√¢ncia
            const last = await db.collection("usuarios").doc(user.uid).collection("dias").orderBy("__name__", "desc").limit(1).get();
            if(!last.empty) dbLocal.todos = last.docs[0].data().todos.map(t => ({...t, completed: false}));
        }
        updateUI();
        updateStreak(user.uid);
    }

    function updateUI() {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        let done = 0;
        dbLocal.todos.forEach(t => {
            const li = document.createElement('li');
            li.className = 'todo-item';
            li.innerHTML = `
                <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo('${t.id}')" style="width:22px; height:22px; cursor:pointer;">
                <span style="margin-left:15px; flex:1; font-weight:600; ${t.completed ? 'text-decoration:line-through; opacity:0.4' : ''}">${t.text}</span>
                <button class="delete-btn" onclick="deleteTodo('${t.id}')">üóëÔ∏è</button>
            `;
            list.appendChild(li);
            if(t.completed) done++;
        });
        const p = dbLocal.todos.length > 0 ? Math.round((done/dbLocal.todos.length)*100) : 0;
        if(p === 100 && dbLocal.percent < 100) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        dbLocal.percent = p;
        document.getElementById('progress-bar').style.width = p + '%';
        document.getElementById('stats').innerText = `Total: ${p}%`;
        saveData();
    }

    function saveData() {
        const user = firebase.auth().currentUser;
        if(user) db.collection("usuarios").doc(user.uid).collection("dias").doc(dbKey).set(dbLocal);
    }

    function addTodo() {
        const inp = document.getElementById('todo-input');
        if(!inp.value) return;
        // ID √öNICO via timestamp conforme pacto
        dbLocal.todos.push({ id: Date.now().toString(), text: inp.value, completed: false });
        inp.value = '';
        updateUI();
    }

    function toggleTodo(id) {
        const t = dbLocal.todos.find(x => x.id === id);
        if(t) t.completed = !t.completed;
        updateUI();
    }

    function deleteTodo(id) {
        dbLocal.todos = dbLocal.todos.filter(x => x.id !== id);
        updateUI();
    }

    // Fun√ß√µes de Interface
    function showRandomQuote() {
        document.getElementById('quote-display').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
    }

    async function updateStreak(uid) {
        const snap = await db.collection("usuarios").doc(uid).collection("dias").where("percent", "==", 100).get();
        document.getElementById('streak-display').innerText = `üî• ${snap.size}`;
    }

    function toggleTheme() {
        const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', t);
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
    }

    // EXPORTAR PDF - Estilo Ticket de Compra (Recuperado)
    function exportToPDF() {
        const ticket = document.createElement('div');
        ticket.style.cssText = "width: 80mm; padding: 20px; font-family: 'Courier New', monospace; color: black; background: white;";
        
        let itemsHtml = dbLocal.todos.map(t => `
            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 5px 0;">
                <span>${t.text.substring(0, 20)}</span>
                <span>${t.completed ? 'OK' : '--'}</span>
            </div>
        `).join('');

        ticket.innerHTML = `
            <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin:0;">ALVORADA</h2>
                <small>PROTOCOLO DE MISS√ïES</small><br>
                <small>${todayStr.toUpperCase()}</small>
            </div>
            <div style="margin-bottom: 10px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; border-bottom:1px solid #000;">
                    <span>MISS√ÉO</span>
                    <span>STATUS</span>
                </div>
                ${itemsHtml}
            </div>
            <div style="text-align:right; font-weight:bold; border-top: 2px solid #000; padding-top:10px;">
                TOTAL: ${dbLocal.percent}%
            </div>
            <div style="text-align:center; margin-top:20px; font-size:10px;">
                *** FOCO NA MISS√ÉO - PC ***
            </div>
        `;

        const opt = {
            margin: 0,
            filename: `Relat√≥rio_${dbKey.replace(/\//g, '-')}.pdf`,
            html2canvas: { scale: 3 },
            jsPDF: { unit: 'mm', format: [80, 150], orientation: 'portrait' }
        };
        html2pdf().set(opt).from(ticket).save();
    }

    document.getElementById('date-box').innerText = todayStr;
</script>
</body>
</html>
