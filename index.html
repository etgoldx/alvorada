<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdfaf6">

    <title>Alvorada - 1% Todo Dia</title>
    
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #fdfaf6; --card-bg: #ffffff; --title-brown: #a68966;
            --add-red: #f28482; --check-green: #32cd32; --item-done-bg: #e8f5e9;
            --stats-green: #7ebc89; --bar-bg: rgba(0,0,0,0.05);
            --bar-1: #a8dadc; --bar-2: #ffcad4; --bar-3: #b9fbc0;
            --text-color: #5d5d5d; --date-color: #999;
            --input-border: #f0f0f0; --delete-red: #e74c3c;
        }

        [data-theme="dark"] {
            --bg-color: #1a1c22; --card-bg: #2d3039; --text-color: #e0e0e0;
            --input-border: #3d414d; --title-brown: #c5b299;
            --bar-bg: rgba(255,255,255,0.15); --item-done-bg: #1b3d2f;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.4s ease; min-height: 100vh;
        }

        #auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .container {
            width: 100%; max-width: 450px;
            background: var(--card-bg); padding: 30px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-top: 20px; position: relative; box-sizing: border-box;
        }

        header { margin-bottom: 35px; }
        h1 { font-family: 'Comfortaa', cursive; font-size: 1.5rem; margin: 0; color: var(--title-brown); }
        #current-date { font-size: 0.85rem; color: var(--date-color); font-weight: 600; text-transform: capitalize; margin-top: 8px; display: block; }
        
        .progress-container { background: var(--bar-bg); border-radius: 20px; height: 14px; margin-bottom: 10px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--bar-1), var(--bar-2), var(--bar-3)); transition: width 0.8s ease; }
        .stats-text { font-size: 0.9rem; text-align: right; margin-bottom: 25px; font-weight: 700; color: var(--stats-green); }

        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        input[type="text"], input[type="email"], input[type="password"] { 
            flex: 1; padding: 12px; border: 2px solid var(--input-border); 
            background: var(--card-bg); color: var(--text-color); 
            border-radius: 12px; outline: none; font-family: inherit; font-size: 16px !important;
        }

        .todo-list { list-style: none; padding: 0; margin-bottom: 30px; }
        .todo-item { 
            background: var(--card-bg); border: 1px solid var(--input-border); 
            padding: 12px 15px; border-radius: 15px; display: flex; 
            align-items: center; margin-bottom: 12px; 
        }
        .todo-item.completed { background-color: var(--item-done-bg); }

        #custom-confirm {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--card-bg); border: 2px solid var(--title-brown); padding: 25px;
            border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); z-index: 2000;
            width: 280px; text-align: center;
        }

        .theme-toggle { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--title-brown); border: none; cursor: pointer; color: white; z-index: 999; }
    </style>
</head>
<body ondblclick="toggleFullScreen()">

<div id="auth-container">
    <div class="container" style="text-align: center;">
        <h1 style="margin-bottom: 20px;">Portaria Alvorada</h1>
        <input type="email" id="auth-email" placeholder="E-mail do Agente" style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
        <input type="password" id="auth-password" placeholder="Senha" style="width: 100%; margin-bottom: 20px; box-sizing: border-box;">
        <button onclick="handleAuth()" id="auth-btn" style="width:100%; padding:15px; background:var(--title-brown); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ACESSAR SISTEMA</button>
        <p id="auth-error" style="color:var(--delete-red); font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div id="custom-confirm">
    <p id="confirm-msg" style="font-weight: 600;"></p>
    <div style="display: flex; justify-content: space-around; margin-top: 20px;">
        <button style="padding: 8px 20px; border-radius: 10px; border: none; cursor: pointer;" onclick="closeConfirm(false)">Cancelar</button>
        <button style="padding: 8px 20px; border-radius: 10px; border: none; cursor: pointer; background: var(--delete-red); color: white;" onclick="closeConfirm(true)">Excluir</button>
    </div>
</div>

<div class="container" id="main-app-container">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Alvorada</h1>
            <div id="streak-display" style="font-weight: 700; color: #ff9f43;">üî• 0 dias</div>
        </div>
        <span id="current-date">Carregando...</span>
    </header>

    <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
    <div id="stats" class="stats-text">TOTAL: 0%</div>

    <div class="input-group">
        <input type="text" id="todo-input" placeholder="Nova miss√£o de hoje...">
        <button onclick="addTodo()" style="background:var(--add-red); border:none; padding:0 18px; border-radius:12px; color:white; font-weight:bold; font-size:1.5rem; cursor:pointer;">+</button>
    </div>

    <ul id="todo-list" class="todo-list"></ul>
    
    <div style="text-align: center;">
        <button onclick="firebase.auth().signOut()" style="background:none; border:none; color:var(--date-color); font-size:0.7rem; cursor:pointer; text-decoration:underline;">Sair do Sistema</button>
    </div>
</div>

<button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>

<script>
    // CONFIGURA√á√ÉO FIREBASE - Cole suas chaves aqui
    const firebaseConfig = {
        apiKey: "SUA_API_KEY",
        authDomain: "SEU_PROJETO.firebaseapp.com",
        projectId: "SEU_PROJETO",
        storageBucket: "SEU_PROJETO.appspot.com",
        messagingSenderId: "SEU_ID",
        appId: "SUA_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const dbFirestore = firebase.firestore();
    const todayStr = new Date().toLocaleDateString('pt-BR');
    let dbLocal = { todos: [], percent: 0 };
    let confirmCallback = null;

    function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const btn = document.getElementById('auth-btn');
        const errorMsg = document.getElementById('auth-error');
        
        if(!email || !password) { errorMsg.innerText = "Preencha todos os campos."; return; }
        btn.innerText = "VERIFICANDO...";
        
        firebase.auth().signInWithEmailAndPassword(email, password)
            .catch(() => firebase.auth().createUserWithEmailAndPassword(email, password))
            .catch(err => {
                errorMsg.innerText = "Erro: Credenciais inv√°lidas.";
                document.getElementById('auth-password').value = '';
                btn.innerText = "ACESSAR SISTEMA";
            });
    }

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            document.getElementById('auth-container').style.display = 'none';
            syncFirestore();
        } else {
            document.getElementById('auth-container').style.display = 'flex';
        }
    });

    async function syncFirestore() {
        const user = firebase.auth().currentUser;
        if(!user) return;
        const docRef = dbFirestore.collection("usuarios").doc(user.uid).collection("dias").doc(todayStr);
        const docSnap = await docRef.get();

        if (docSnap.exists()) {
            dbLocal = docSnap.data();
        } else {
            const lastDay = await dbFirestore.collection("usuarios").doc(user.uid).collection("dias").orderBy("__name__", "desc").limit(1).get();
            if (!lastDay.empty) {
                const data = lastDay.docs[0].data();
                dbLocal = { todos: data.todos.map(t => ({...t, completed: false})), percent: 0 };
            }
        }
        updateUI();
        updateTotalStreak();
    }

    function updateUI() {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        let completed = 0;
        
        dbLocal.todos.forEach((todo, index) => {
            const li = document.createElement('li');
            li.className = 'todo-item ' + (todo.completed ? 'completed' : '');
            li.innerHTML = `
                <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${index})" style="margin-right:12px; width:20px; height:20px;">
                <span style="flex:1; font-size:0.95rem; ${todo.completed ? 'text-decoration:line-through; opacity:0.6' : ''}">${todo.text}</span>
                <button onclick="deleteTodo(${index})" style="background:none; border:none; cursor:pointer; opacity:0.5;">üóëÔ∏è</button>
            `;
            list.appendChild(li);
            if (todo.completed) completed++;
        });

        const percent = dbLocal.todos.length > 0 ? Math.round((completed / dbLocal.todos.length) * 100) : 0;
        if (percent === 100 && dbLocal.percent < 100) confetti({ particleCount: 150, spread: 70 });
        
        dbLocal.percent = percent;
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('stats').innerText = `TOTAL: ${percent}%`;
        saveData();
    }

    async function updateTotalStreak() {
        const user = firebase.auth().currentUser;
        const days = await dbFirestore.collection("usuarios").doc(user.uid).collection("dias").where("percent", "==", 100).get();
        document.getElementById('streak-display').innerText = `üî• ${days.size} dias`;
    }

    function saveData() {
        const user = firebase.auth().currentUser;
        if (user) dbFirestore.collection("usuarios").doc(user.uid).collection("dias").doc(todayStr).set(dbLocal);
    }

    function toggleTodo(i) { dbLocal.todos[i].completed = !dbLocal.todos[i].completed; updateUI(); }
    function addTodo() {
        const input = document.getElementById('todo-input');
        if (input.value) { dbLocal.todos.push({text: input.value, completed: false}); updateUI(); }
        input.value = '';
    }

    function deleteTodo(i) {
        showConfirm("Remover esta miss√£o?", (ok) => {
            if(ok) { dbLocal.todos.splice(i, 1); updateUI(); }
        });
    }

    function showConfirm(msg, callback) {
        document.getElementById('confirm-msg').innerText = msg;
        document.getElementById('custom-confirm').style.display = 'block';
        confirmCallback = callback;
    }

    function closeConfirm(res) {
        document.getElementById('custom-confirm').style.display = 'none';
        if (confirmCallback) confirmCallback(res);
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    function toggleTheme() {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        document.getElementById('theme-btn').innerText = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    setInterval(() => {
        const pendentes = dbLocal.todos.filter(t => !t.completed).length;
        if (pendentes > 0 && Notification.permission === "granted") {
            new Notification("Alvorada", { body: `Agente, voc√™ tem ${pendentes} miss√µes pendentes.` });
        }
    }, 3600000);

    document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'long'});
</script>
</body>
</html>
